doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Manager Dashboard
    link(rel="stylesheet", href="/CSS/stockreport.css")

  body
    // Navbar
    header.navbar
      .brand
        a(href="/")
          img(src="/Images/mayondo logo.png", alt="Company Logo")
        h2 Mayondo Wood And Furniture
      nav.nav-links
        a(href="/saleslist") Sales
        a(href="/stafflist") Register
        .dropdown
          a(href="/analytic") Reports â–¼
          .dropdown-content
            a(href="/accounting") Accounting
            a(href="/dashboard") Manager
            a(href="/suppliers") Suppliers
        a(href="/stockreport") Stock
        if user
          a.btn-logout(href="#" onclick="showLogoutConfirmation()") Logout

    h2 ðŸ“Š Products Report

    // ======================
    // Search Bar (Right Corner)
    // ======================
    .search-container(style="display:flex; justify-content:flex-end; margin-bottom:20px;")
      form(action="/stockreport" method="GET")
        input#stockreport-search(
          type="text", 
          name="q", 
          placeholder="ðŸ” Search products, supplier, or status...", 
          value=query || "", 
          style="padding:5px 10px;"
        )
        button(type="submit", style="padding:5px 10px; margin-left:5px;") Search

    // ======================
    // Add / Update Form (Wood)
    // ======================
    form(action=editItem ? `/updatestock/${editItem._id}` : "/stockreport" method="post")
      select(name="product" required)
        option(value="") Select Wood Type
        option(value="Oak" selected=editItem && editItem.product=="Oak") Oak
        option(value="Pine" selected=editItem && editItem.product=="Pine") Pine
        option(value="Mahogany" selected=editItem && editItem.product=="Mahogany") Mahogany
        option(value="Teak" selected=editItem && editItem.product=="Teak") Teak
      input(type="number", name="quantity", placeholder="Quantity", required, value=editItem ? editItem.quantity : "")
      input(type="number", name="price", placeholder="Price per Unit", required, step="0.01", value=editItem ? editItem.price : "")
      input(type="text", name="supplier", placeholder="Supplier", required, value=editItem ? editItem.supplier : "")
      input(type="text", name="supplierEmail", placeholder="Supplier Email", required, value=editItem ? editItem.supplierEmail : "")
      input(type="text", name="supplierContact", placeholder="Supplier Contact", value=editItem ? editItem.supplierContact : "")
      input(type="date", name="date", required, value=editItem ? editItem.date : "")
      input(type="hidden", name="category", value="wood")
      button(type="submit") #{editItem ? "Update Wood" : "Add Wood"}

    // ======================
    // Wood Stock Report
    // ======================
    h3 ðŸªµ Wood Stock Report
    table#woodReport
      thead
        tr
          th Wood Type
          th Quantity
          th Price
          th Status
          th Supplier
          th Supplier Contact
          th Date
          th Actions
      tbody
        each item in items
          if item.category == "wood"
            tr
              td= item.product
              td= item.quantity
              td ugx#{item.price}
              td= item.status
              td= item.supplier
              td= item.supplierContact || ""
              td= item.date ? item.date.toDateString() : ""
              td
                form(method="get", action=`/updatestock/${item._id}`, style="display:inline")
                  button.btn.btn-info(type="submit") Edit
                button.btn.btn-danger(type="button", onclick=`showDeleteConfirmation('${item._id}', '${item.product}', 'wood stock item')`, style="margin-left:5px;") Delete

    // ======================
    // Add / Update Form (Furniture)
    // ======================
    h2 ðŸ›‹ï¸ Finished Furniture
    form(action=editItem ? `/updatestock/${editItem._id}` : "/stockreport" method="post")
      select(name="product" required)
        option(value="") Select Furniture Type
        option(value="Chair" selected=editItem && editItem.product=="Chair") Chair
        option(value="Table" selected=editItem && editItem.product=="Table") Table
        option(value="Sofa" selected=editItem && editItem.product=="Sofa") Sofa
        option(value="Bed" selected=editItem && editItem.product=="Bed") Bed
      input(type="number", name="quantity", placeholder="Quantity", required, value=editItem ? editItem.quantity : "")
      input(type="number", name="price", placeholder="Sale Price", required, step="0.01", value=editItem ? editItem.price : "")
      input(type="text", name="supplier", placeholder="Supplier", required, value=editItem ? editItem.supplier : "")
      input(type="text", name="supplierEmail", placeholder="Supplier Email", required, value=editItem ? editItem.supplierEmail : "")
      input(type="text", name="supplierContact", placeholder="Supplier Contact", value=editItem ? editItem.supplierContact : "")
      input(type="date", name="date", required, value=editItem ? editItem.date : "")
      input(type="hidden", name="category", value="furniture")
      button(type="submit") #{editItem ? "Update Furniture" : "Add Furniture"}

    // Furniture Stock Report
    h3 ðŸ›‹ï¸ Furniture Stock Report
    table#furnitureReport
      thead
        tr
          th Product
          th Quantity
          th Price
          th Status
          th Supplier
          th Supplier Contact
          th Date
          th Actions
      tbody
        each item in items
          if item.category == "furniture"
            tr
              td= item.product
              td= item.quantity
              td ugx#{item.price}
              td= item.status
              td= item.supplier
              td= item.supplierContact || ""
              td= item.date ? item.date.toDateString() : ""
              td
                form(method="get", action=`/updatestock/${item._id}`, style="display:inline")
                  button.btn.btn-info(type="submit") Edit
                button.btn.btn-danger(type="button", onclick=`showDeleteConfirmation('${item._id}', '${item.product}', 'furniture stock item')`, style="margin-left:5px;") Delete

    // Page script
    script(src="/Javascript/stockreport.js")

    // Delete Confirmation Modal
    #deleteModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Deletion
        .modal-body(style="margin-bottom: 20px;")
          p#deleteMessage(style="margin: 0;") Are you sure you want to delete this item?
          p(style="margin: 10px 0 0 0; font-weight: bold;") #[span#deleteDetails]
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmDelete()") Delete
          button.btn.btn-secondary(type="button", onclick="closeDeleteModal()", style="margin-left: 10px;") Cancel
    // Logout Confirmation Modal
    #logoutModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Logout
        .modal-body(style="margin-bottom: 20px;")
          p#logoutMessage(style="margin: 0;") Are you sure you want to log out?
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmLogout()") Logout
          button.btn.btn-secondary(type="button", onclick="closeLogoutModal()", style="margin-left: 10px;") Cancel

    script.
      function showLogoutConfirmation() {
        document.getElementById('logoutModal').style.display = 'block';
      }
      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function confirmLogout() {
        window.location.href = '/logout';
      }

      let deleteId = '';
      function showDeleteConfirmation(id, product, category) {
        deleteId = id;
        document.getElementById('deleteDetails').textContent = `${product} - ${category}`;
        document.getElementById('deleteModal').style.display = 'block';
      }

      function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
      }

      function confirmDelete() {
        if (deleteId) {
          fetch(`/delete`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${deleteId}` })
            .then(response => {
              if (response.ok) {
                location.reload();
              } else {
                alert('Error deleting item');
              }
            })
            .catch(err => {
              console.error('Error:', err);
              alert('Error deleting item');
            });
        }
      }

      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const deleteModal = document.getElementById('deleteModal');
        const logoutModal = document.getElementById('logoutModal');
        if (event.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
        if (event.target === logoutModal) {
          logoutModal.style.display = 'none';
        }
      }
