doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Detailed Stock Report - Mayondo Wood And Furniture
    link(rel="stylesheet", href="/CSS/stockreport.css")

  body
    // Navbar
    header.navbar
      .brand
        a(href="/")
          img(src="/Images/mayondo logo.png", alt="Company Logo")
        h2 Mayondo Wood And Furniture
      nav.nav-links
        a(href="/saleslist") Sales
        a(href="/stafflist") Staff
        .dropdown
          a(href="/analytic") Reports â–¼
          .dropdown-content
            a(href="/accounting") Accounting
            a(href="/dashboard") Manager
            a(href="/suppliers") Suppliers
        .dropdown
          a(href="/stockreport") Stock  â–¼
          .dropdown-content
            a(href="/stockreport/detailed") Stock report
        if user
          a.btn-logout(href="#" onclick="showLogoutConfirmation()") Logout

    h2(style="margin: 20px 40px 10px 40px;") ðŸ“‹ Stock Report

    // Search Bar
    .search-container(style="display:flex; justify-content:flex-end; margin: 20px 40px;")
      form(action="/stockreport/detailed" method="GET")
        input#stockreport-search(
          type="text",
          name="q",
          placeholder="ðŸ” Search products, supplier, or status...",
          value=query || "",
          style="padding:5px 10px;"
        )
        button(type="submit", style="padding:5px 10px; margin-left:5px;") Search

    // Detailed Stock Report Table
    .table-container(style="margin: 20px 40px; overflow-x: auto;")
      h3 ðŸ“¦ All Stock Entries (Individual Records)
      if items && items.length
        table#detailedStockReport
          thead
            tr
              th Product
              th Category
              th Quantity
              th Price
              th Status
              th Supplier
              th Supplier Email
              th Supplier Contact
              th Date Added
              th Edit
              th Delete
          tbody
            each item in items
              tr
                td= item.product
                td= item.category
                td= item.quantity
                td UGX #{item.price ? item.price.toLocaleString() : 'N/A'}
                td= item.status || 'Available'
                td= item.supplier || 'N/A'
                td= item.supplierEmail || 'N/A'
                td= item.supplierContact || 'N/A'
                td= item.date ? new Date(item.date).toLocaleDateString('en-GB', { timeZone: 'UTC' }) : 'N/A'
                td
                  form(method="get", action=`/updatestock/${item._id}`, style="display:inline")
                    button.btn.btn-info(type="submit") Edit
                td
                  button.btn.btn-danger(type="button", onclick=`showDeleteConfirmation('${item._id}', '${item.product}', '${item.category}')`) Delete
      else
        p No stock items found.

    // Page script
    script(src="/Javascript/stockreport.js")

    // Footer
    footer#footer(style="position: fixed; bottom: 0; left: 0; right: 0; background-color: #5d4037; padding: 10px 0; text-align: center; border-top: 1px solid #dee2e6; margin-top: 20px;")
      p(style="margin: 0; color: #ffffff; font-size: 14px;") Â© 2024 Mayondo Wood And Furniture. All rights reserved.

    // Delete Confirmation Modal
    #deleteModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Deletion
        .modal-body(style="margin-bottom: 20px;")
          p#deleteMessage(style="margin: 0;") Are you sure you want to delete this item?
          p(style="margin: 10px 0 0 0; font-weight: bold;") #[span#deleteDetails]
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmDelete()") Delete
          button.btn.btn-secondary(type="button", onclick="closeDeleteModal()", style="margin-left: 10px;") Cancel

    // Logout Confirmation Modal
    #logoutModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Logout
        .modal-body(style="margin-bottom: 20px;")
          p#logoutMessage(style="margin: 0;") Are you sure you want to log out?
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmLogout()") Logout
          button.btn.btn-secondary(type="button", onclick="closeLogoutModal()", style="margin-left: 10px;") Cancel

    script.
      function showLogoutConfirmation() {
        document.getElementById('logoutModal').style.display = 'block';
      }
      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }
      function confirmLogout() {
        window.location.href = '/logout';
      }

      let deleteId = '';
      function showDeleteConfirmation(id, product, category) {
        deleteId = id;
        document.getElementById('deleteDetails').textContent = `${product} (${category})`;
        document.getElementById('deleteModal').style.display = 'block';
      }

      function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
      }

      function confirmDelete() {
        if (deleteId) {
          fetch(`/delete`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${deleteId}` })
            .then(response => {
              if (response.ok) {
                location.reload();
              } else {
                alert('Error deleting item');
              }
            })
            .catch(err => {
              console.error('Error:', err);
              alert('Error deleting item');
            });
        }
      }

      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const deleteModal = document.getElementById('deleteModal');
        const logoutModal = document.getElementById('logoutModal');
        if (event.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
        if (event.target === logoutModal) {
          logoutModal.style.display = 'none';
        }
      }
