doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Orders List - Mayondo Wood And Furniture
    link(rel="stylesheet", href="/CSS/orders.css")

  body
    // Navbar
    header.navbar
      .brand
        a(href="/")
          img(src="/Images/mayondo logo.png", alt="Company Logo")
        h2 Mayondo Wood And Furniture
      nav.nav-links
        a(href="admin/upload") Storeupdate
        a(href="orders") Orders
        a(href="addsale") Sales
        //- a(href="managersales") Manager Sales
        a(href="ecommerce") Store
        if user
          button.btn.btn-logout(type="button", onclick="showLogoutConfirmation()") Logout

    main
      h2 Orders List
      table
        thead
          tr
            th Customer
            th Phone
            th Address
            th Items
            th Total
            th Date
            th Status
        tbody
          if orders && orders.length
            each order in orders
              tr
                td= order.customerName
                td= order.phoneNumber
                td= order.address
                td
                  ul
                    each item in order.items
                      li #{item.name} — UGX #{item.price} × #{item.quantity}
                td UGX #{order.total}
                td= new Date(order.date).toLocaleString()
                td
                  if order.status === 'pending'
                    span.badge.badge-warning Pending
                    button.btn.btn-success.btn-sm(onclick=`markAsDelivered('${order._id}')`, style="margin-left: 5px;") Mark Delivered
                  else if order.status === 'delivered'
                    span.badge.badge-success Delivered
                    button.btn.btn-danger.btn-sm(onclick=`deleteOrder('${order._id}')`, style="margin-left: 5px;") Clear
          else
            tr
              td(colspan="7") No orders found.

    // Footer
    footer.footer(style="position: fixed; bottom: 0; left: 0; right: 0; background-color: :#5d4037; padding: 10px; text-align: center; border-top: 1px solid #ddd;")
      .footer-content
        p © 2025 Mayondo Wood And Furniture. All rights reserved.

    // Logout Confirmation Modal
    #logoutModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Logout
        .modal-body(style="margin-bottom: 20px;")
          p#logoutMessage(style="margin: 0;") Are you sure you want to log out?
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmLogout()") Logout
          button.btn.btn-secondary(type="button", onclick="closeLogoutModal()", style="margin-left: 10px;") Cancel

    // Order Deletion Confirmation Modal
    #deleteModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Deletion
        .modal-body(style="margin-bottom: 20px;")
          p#deleteMessage(style="margin: 0;") Are you sure you want to delete this delivered order?
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmDeleteOrder()") Delete
          button.btn.btn-secondary(type="button", onclick="closeDeleteModal()", style="margin-left: 10px;") Cancel

    script.
      let currentOrderId = null; // To store the order ID for deletion

      function showLogoutConfirmation() {
        const modal = document.getElementById('logoutModal');
        console.log('Modal element:', modal); // Debug to console
        if (modal) {
          modal.style.display = 'block';
        } else {
          alert('Modal not found! Check console for details.');
        }
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function confirmLogout() {
        window.location.href = '/logout';
      }

      function markAsDelivered(orderId) {
        fetch(`/orders/${orderId}/deliver`, {
          method: 'PUT'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error updating order: ' + data.message);
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('An error occurred while updating the order.');
        });
      }

      function deleteOrder(orderId) {
        currentOrderId = orderId; // Store the order ID
        document.getElementById('deleteModal').style.display = 'block'; // Show the custom modal
      }

      function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        currentOrderId = null;
      }

      function confirmDeleteOrder() {
        if (currentOrderId) {
          fetch(`/orders/${currentOrderId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error deleting order: ' + data.message);
            }
          })
          .catch(err => {
            console.error('Error:', err);
            alert('An error occurred while deleting the order.');
          });
        }
        closeDeleteModal();
      }

      // Close modals when clicking outside of them
      window.onclick = function(event) {
        const logoutModal = document.getElementById('logoutModal');
        const deleteModal = document.getElementById('deleteModal');
        if (event.target === logoutModal) {
          logoutModal.style.display = 'none';
        }
        if (event.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
      }
