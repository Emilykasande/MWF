doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title My Sales
    link(rel="stylesheet", href="/CSS/addsale.css")

  body
    //- Navbar
    header.navbar
      .brand
        a(href="index.html")
          img(src="/Images/mayondo logo.png", alt="Company Logo")
        h2 Mayondo Wood And Furniture
      nav.nav-links
        a(href="admin/upload") Storeupdate
        a(href="orders") Orders
        a(href="addsale") Sales
        a(href="ecommerce") Store
        if user
          a(href="#" onclick="showLogoutConfirmation()" class="btn-logout") Logout

    // Logout Confirmation Modal
    #logoutModal.modal(style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);")
      .modal-content(style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);")
        .modal-header(style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;")
          h3(style="margin: 0; color: #d9534f;") Confirm Logout
        .modal-body(style="margin-bottom: 20px;")
          p#logoutMessage(style="margin: 0;") Are you sure you want to log out?
        .modal-footer(style="text-align: right;")
          button.btn.btn-danger(type="button", onclick="confirmLogout()") Logout
          button.btn.btn-secondary(type="button", onclick="closeLogoutModal()", style="margin-left: 10px;") Cancel

    script.
      // Load products for the dropdown
      fetch('/api/products')
        .then(response => response.json())
        .then(products => {
          const productSelect = document.getElementById('product');
          products.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.product;
            option.textContent = `${prod.product} (Stock: ${prod.quantity})`;
            productSelect.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Error loading products:', err);
        });

      function showLogoutConfirmation() {
        document.getElementById('logoutModal').style.display = 'block';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function confirmLogout() {
        window.location.href = '/logout';
      }

      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById('logoutModal');
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      }

    .container
      .flex-container(style="display: flex; gap: 20px; flex-wrap: wrap;")
        //- Add Sale Form
        .card(style="flex: 1; min-width: 300px;")
          h2 Add New Sale
          form#salesForm(action="/addsale", method="POST")
            label(for="customername") Customer Name
            input#customername(
              type="text",
              name="customername",
              placeholder="Customer Name",
              required,
              value=(formData && formData.customername) || ''
            )
            
            label(for="product") Product
            select#product(name="product", required)
              option(value="", disabled, selected) Select a product
              // Products will be loaded here via JavaScript
            
            label(for="quantity") Quantity
            input#quantity(
              type="number",
              name="quantity",
              required,
              value=(formData && formData.quantity) || '1'
            )
            
            label(for="price") Unit Price
            input#price(
              type="number",
              step="0.01",
              name="price",
              required,
              value=(formData && formData.price) || '0.00'
            )
            
            label(for="transport") Transport Required?
            select#transport(name="transport")
              option(value="no", selected=(formData && formData.transport === 'no')) No
              option(value="yes", selected=(formData && formData.transport === 'yes')) Yes (+5%)
            
            label(for="paymentMethod") Payment Type
            select#paymentMethod(name="paymentMethod")
              option(value="cash", selected=(formData && formData.paymentMethod === 'cash')) Cash
              option(value="mobile", selected=(formData && formData.paymentMethod === 'mobile')) Mobile Money
              option(value="bank", selected=(formData && formData.paymentMethod === 'bank')) Bank Transfer
            
            label(for="date") Date
            input#date(
              type="date",
              name="date",
              required,
              value=(formData && formData.date) || ''
            )
            
            button(type="submit") Record Sale

      //- Agent Sales Table
      .card(style="margin-top: 20px;")
        h2 My Sales
        table#salesTable
          thead
            tr
              th Customer
              th Product
              th Quantity
              th Unit Price
              th Total Price
              th Payment
              th Sales Agent
              th Date
              th Actions
          tbody
            if sales && sales.length
              each sale in sales
                tr
                  td= sale.customername
                  td= sale.product
                  td= sale.quantity
                  td UGX #{sale.price}
                  td UGX #{(sale.quantity * sale.price).toFixed(2)}
                  td= sale.paymentMethod
                  td= sale.salesAgent ? sale.salesAgent.fullname : "Unknown"
                  td= sale.formattedDate
                  td
                    form(method="get", action=`/sales/receipt/${sale._id}`, style="display:inline")
                      button.btn.btn-primary(type="submit") Receipt
            else
              tr
                td(colspan="9") You have not recorded any sales yet.

    //- Footer
    footer
      
      .footer-bottom
        | Â© 2025 Mayondo Wood and Furniture. All rights reserved.

